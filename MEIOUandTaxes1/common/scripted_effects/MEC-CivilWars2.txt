setup_civil_war2 = {
	if = {
		limit = {
			num_of_cities = 4
		}
		hidden_effect = {
			[[elite]
				setup_civil_war_vassals = {
					orig_scope = $orig_scope$
					elite = $elite$
					rebel_tag = $rebel_tag$
					strength_type = $strength_type$
					strength_inp = $strength_inp$
				}
			]
		}
	}
	else = {
		Stab_Subtract4 = yes
		add_war_exhaustion = 7.5
		add_prestige = -50
		spawn_rebels = {
			type = pretender_rebels
			size = 4
			win = yes		#Make them immediatelly have control of the province they spawn in
		}
		every_owned_province = {
			add_devastation = 15
		}
		[[elite]
			Public_ChangePowerbrokerLoyaltyTooltipProv = { Powerbroker=$elite$ Amount=-60 }
		]
		hidden_effect = {
			Rights_ReformReset = yes
		}
	}
}

setup_civil_war_vassals = {
	if = {
		limit = {
			$rebel_tag$ = {
				is_subject_of = $orig_scope$
			}
			num_of_cities = 4
		}

		### Setup general flags and keys
		set_country_flag = ongoing_civil_war
		set_country_flag = civil_war_orig_tag
		set_country_flag = civil_war_$elite$_rebels
		set_country_flag = PriorityTag
	
		log = "[GetYear]: [Root.GetName] entered Civil War"
		set_key = { lhs = cw_total_control_abs which = Dev_Total }	

		### Determine a center of the rebellion
		civil_war_find_mp_center = {
			orig_scope = $orig_scope$
			elite = $elite$
		}

		civil_war_determine_strength_in_perc = {
			elite = $elite$
			strength_mode_dev = no
			strength_inp = $strength_inp$
			strength_type = $strength_type$
		}

		civil_war_calculate_manpower = {
			elite = $elite$
			cw_strength_percentage = cw_rebellion_strength_percentage 
		}

		# calculate_provinces = {
		# 	start_event_target = cw_rebellion_center
		# 	start_flag = rebellion_center
		# 	iter_flag = assigned_rebellion
		# 	elite = $elite$
		# 	end_perc_key = cw_rebellion_mp_strength
		# 	core_add_tag = $rebel_tag$
		# }
	}
}

# determine civil war center 
civil_war_find_mp_center = {
    set_key = { lhs = Public_Tmp0 value = 0 }
	set_key = { lhs = Public_Tmp3 value = 0 }

	### find province with highest manpower
	every_owned_province = {
		limit = {
			check_key = { lhs = Public_Tmp0 which = $orig_scope$ }
			NOT = { is_capital = yes }
            any_neighbor_province = {
                owned_by = $orig_scope$
            }
		}
		export_to_key = { 
			lhs = Public_Tmp0
			which = $elite$_MPNOCur
		}

		log = "[GetYear]: Tmp0 [Public_Tmp0.GetValue] manpower"
        
		$orig_scope$ = { 
			set_key = { lhs = Public_Tmp0 which = PREV }
			
			if = {
				limit = {
					check_key = { lhs = Public_Tmp3 which = Public_Tmp0 }
				}

				set_key = { lhs = Public_Tmp3 which = PREV }
				log = "[GetYear]: Tmp3 [Public_Tmp3.GetValue] manpower"
			} 
		}
	}

	random_owned_province = {
		limit = { 
            is_key_equal = { lhs = $elite$_MPNOCur which = Public_Tmp3 } 
        }
		
		save_global_event_target_as = cw_rebellion_center
	}
}


civil_war_calculate_manpower = {
	#Work out current elite manpower
	set_key = { lhs = $cw_rebellion_mp_strength$ value = 0 }

	every_owned_province = {
		limit = {
			NOT = { is_capital = yes }
		}

		change_key = { 
			lhs = $cw_rebellion_mp_strength$ 
			which = $elite$_MPNOCur
		}
	}
	log = "[GetYear]: [Root.cw_rebellion_mp_strength.GetValue] manpower"
	multiply_key = { lhs = $cw_rebellion_mp_strength$ which = $cw_strength_percentage$ }
}

# calculate_provinces = {
#     event_target:$start_event_target$ = {
#         set_province_flag = $start_flag$
#     }
		
#     while = {
# 		limit = { 
#             NOT = { 
#                 check_key = { lhs = $end_perc_key$ value = 0  } 
#             } 
#         }

# 		random_owned_province = {
# 			limit = {
# 				owned_by = ROOT
# 				NOT = { has_province_flag = $iter_flag$ }
# 				NOT = { is_capital = yes }
# 				check_key = { lhs = $end_perc_key$ value = 1 }
# 				check_key = { lhs = $end_perc_key$ which = Public_Tmp0 }
# 				isValidProv = yes
# 			}
			
# 			set_province_flag = $iter_flag$
#             [[core_add_tag]
# 			add_core = $core_add_tag$ 
# 			]

# 			subtract_key = { lhs = $end_perc_key$ which = $elite$_MPNOCur } 
# 		}

# 		subtract_key = { lhs = Public_Tmp0 value = 1 } 
# 	}
# }